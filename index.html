<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moon's Hearth - The Sovereign Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
    :root { --gold: #d4af37; --gold-glow: rgba(212, 175, 55, 0.4); --fire: #ff6a00; --glass: rgba(15, 12, 10, 0.9); --text: #fdf5e6; --parchment: #e3d5b8; --ink: #2c1810; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Cormorant Garamond', serif; background-color: #000; color: var(--text); overflow: hidden; }

    /* --- GLOBAL BACKGROUND LAYERS --- */
    .layer-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 1.5s ease; background-size: cover; background-position: center; z-index: 1; }
    .hidden { display: none !important; }
    .invisible { opacity: 0; pointer-events: none; }
    
    #hearth-layer { background-image: url('image_5.png'); }
    #garden-layer { background-image: url('garden_bg.png'); }
    #scholar-video-bg { width: 100%; height: 100%; object-fit: cover; position: absolute; }

    /* --- NAVIGATION & TOGGLES --- */
    .room-portal { position: fixed; left: 30px; top: 30px; z-index: 2000; display: flex; gap: 10px; }
    .portal-btn, .data-btn { font-family: 'Cinzel', serif; color: var(--gold); background: rgba(0,0,0,0.6); border: 1px solid var(--gold); cursor: pointer; transition: 0.3s; padding: 8px 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; outline: none; }
    .portal-btn:hover, .portal-btn.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold-glow); }

    .sidebar-toggle {
        position: fixed; right: 25px; top: 30px; z-index: 2000;
        width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.8);
        border: 1px solid var(--gold); color: var(--gold); cursor: pointer;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .sidebar-toggle:hover { transform: rotate(15deg) scale(1.1); background: var(--gold); color: #000; }

    /* --- SIDEBAR SYSTEM --- */
    .sidebar { 
        position: fixed; right: -450px; top: 0; width: 420px; height: 100%; 
        background: var(--glass); backdrop-filter: blur(25px); border-left: 1px solid var(--gold-glow); 
        z-index: 1000; transition: right 0.7s cubic-bezier(0.19, 1, 0.22, 1); padding: 90px 35px 40px 35px; 
        box-sizing: border-box; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gold) transparent;
    }
    .sidebar.open { right: 0; }
    
    /* --- UI ELEMENTS --- */
    .panel-header h1 { font-family: 'Cinzel'; font-size: 1.1rem; color: var(--gold); text-align: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 25px; letter-spacing: 4px; text-transform: uppercase; }
    .section-box { margin-bottom: 25px; border: 1px solid rgba(212,175,55,0.2); padding: 20px; background: rgba(255,255,255,0.02); }
    
    .vital-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-family: 'Cinzel'; font-size: 0.8rem; letter-spacing: 1px; }
    .vital-input { background: rgba(0,0,0,0.3); border: 1px solid var(--gold-glow); color: var(--gold); font-family: 'Cinzel'; width: 60px; text-align: center; padding: 5px; outline: none; }
    .scholar-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--gold-glow); color: var(--parchment); padding: 12px; font-family: 'Cormorant Garamond'; margin-bottom: 10px; outline: none; box-sizing: border-box; resize: vertical; }

    .mood-icons { display: flex; gap: 15px; font-size: 1.5rem; justify-content: center; margin: 10px 0; }
    .mood-icons span { cursor: pointer; opacity: 0.3; transition: 0.4s; }
    .mood-icons span.selected { opacity: 1; filter: drop-shadow(0 0 8px var(--gold)); transform: scale(1.2); }

    /* Almanac Grid */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.7rem; font-family: 'Cinzel'; }
    .day-num { padding: 8px 0; border: 1px solid rgba(212,175,55,0.1); transition: 0.3s; cursor: default; }
    .day-num.today { background: var(--gold); color: #000; font-weight: 900; }

    /* --- ANIMATION ENGINE (PARTICLES) --- */
    #particle-layer { pointer-events: none; position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; overflow: hidden; }
    
    /* Hearth Embers */
    .ember { position: absolute; border-radius: 50%; background: var(--fire); box-shadow: 0 0 10px var(--fire); opacity: 0; animation: rise linear infinite; }
    @keyframes rise { 0% {opacity:0; transform:translateY(110vh) translateX(0);} 20% {opacity:0.6;} 100% {opacity:0; transform:translateY(-10vh) translateX(var(--drift));} }
    
    /* Tower Dust */
    .dust { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3); box-shadow: 0 0 8px rgba(255,255,255,0.2); opacity: 0; animation: drift linear infinite; }
    @keyframes drift { 0% {opacity:0; transform:translateY(100vh) translateX(0);} 50% {opacity:0.5;} 100% {opacity:0; transform:translateY(-10vh) translateX(var(--drift));} }

    /* Garden Water Drips */
    .drip { position: absolute; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.5)); width: 2px; border-radius: 2px; opacity: 0; animation: fallDrip linear infinite; }
    @keyframes fallDrip { 0% { opacity: 0; transform: translateY(-10vh); } 10% { opacity: 0.5; } 100% { opacity: 0; transform: translateY(110vh); } }

    /* Garden Petals */
    .petal { position: absolute; background: #c84b31; width: 8px; height: 8px; border-radius: 50% 0 50% 50%; opacity: 0; animation: fallPetal linear infinite; box-shadow: 0 0 5px rgba(200,75,49,0.5); }
    @keyframes fallPetal { 0% { opacity: 0; transform: translateY(-10vh) translateX(0) rotate(0deg); } 20% { opacity: 0.8; } 100% { opacity: 0; transform: translateY(110vh) translateX(var(--drift)) rotate(var(--spin)); } }

</style>
</head>
<body onload="init()">

    <div class="room-portal">
        <button id="btn-hearth" class="portal-btn active" onclick="switchRoom('hearth')">Hearth</button>
        <button id="btn-scholar" class="portal-btn" onclick="switchRoom('scholar')">Tower</button>
        <button id="btn-garden" class="portal-btn" onclick="switchRoom('garden')">Garden</button>
    </div>

    <button id="ui-toggle" class="sidebar-toggle" onclick="toggleSidebar()">üìú</button>

    <audio id="audio-hearth" loop src="fire.mp3"></audio>
    <audio id="audio-garden" loop src="nature.mp3"></audio>

    <div id="hearth-layer" class="layer-container"></div>
    
    <div id="scholar-layer" class="layer-container invisible">
        <video id="scholar-video-bg" loop muted playsinline><source src="scholar_bg.mp4" type="video/mp4"></video>
    </div>

    <div id="garden-layer" class="layer-container invisible"></div>

    <div id="particle-layer"></div>

    <div id="main-sidebar" class="sidebar">
        
        <div id="side-hearth" class="side-content">
            <div class="panel-header"><h1>Hearth Almanac</h1></div>
            <div class="section-box">
                <div class="calendar-grid" id="calendar-body"></div>
            </div>
            <div class="section-box">
                <h3 style="font-family:'Cinzel'; font-size:0.8rem; color:var(--gold); margin-bottom:15px;">Apothecary Reagents</h3>
                <input type="text" id="reagent-input" class="scholar-input" placeholder="Scribe herb or mineral..." onkeydown="if(event.key==='Enter') addReagent()">
                <div id="reagent-display" style="max-height:150px; overflow-y:auto; font-size:1.1rem; border-top: 1px solid rgba(212,175,55,0.1); padding-top:10px;"></div>
            </div>
            <button class="data-btn" style="width:100%" onclick="exportData()">Export Data Scroll</button>
        </div>

        <div id="side-scholar" class="side-content hidden">
            <div class="panel-header"><h1>Scholar's Focus</h1></div>
            <div class="section-box" style="text-align:center;">
                <div id="timer-display" style="font-family:'Cinzel'; font-size:2.8rem; color:var(--gold); margin-bottom:15px; text-shadow: 0 0 10px var(--gold-glow);">25:00</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="data-btn" onclick="startFocusTimer(25)">Begin Focus</button>
                    <button class="data-btn" style="border-color:#8a3324; color:#8a3324;" onclick="resetTimer()">Reset</button>
                </div>
                <p style="font-size:0.8rem; font-style:italic; margin-top:15px; opacity:0.7;">Zen Mode: UI will collapse upon start.</p>
            </div>
            <div class="section-box">
                <h3 style="font-family:'Cinzel'; font-size:0.8rem; color:var(--gold);">Grimoire Entry</h3>
                <textarea id="work-note" class="scholar-input" style="height:120px;" placeholder="What lore are you unearthing?"></textarea>
                <button class="data-btn" style="width:100%;" onclick="logJournal()">Scribe to Journal</button>
            </div>
            <div id="journal-preview" style="max-height:150px; overflow-y:auto; font-size:0.9rem; opacity:0.8;"></div>
        </div>

        <div id="side-garden" class="side-content hidden">
            <div class="panel-header"><h1>Vital Alchemy</h1></div>
            <div class="section-box">
                <div style="font-family:'Cinzel'; text-align:center; color:var(--gold); font-size:0.8rem; margin-bottom:10px;">Spirit Alignment</div>
                <div class="mood-icons" id="mood-picker">
                    <span onclick="updateMood('ethereal', this)" title="Ethereal">‚ú®</span>
                    <span onclick="updateMood('grounded', this)" title="Grounded">üåø</span>
                    <span onclick="updateMood('flickering', this)" title="Flickering">üî•</span>
                    <span onclick="updateMood('stormy', this)" title="Stormy">‚õàÔ∏è</span>
                    <span onclick="updateMood('waning', this)" title="Waning">üåë</span>
                </div>
            </div>
            <div class="section-box">
                <div class="vital-row"><span>Dream Cycles (Sleep)</span> <input type="number" id="sleep-in" class="vital-input" onchange="saveVitals()"></div>
                <div class="vital-row"><span>Restorative Elixir (Water)</span> <input type="number" id="water-in" class="vital-input" onchange="saveVitals()"></div>
                <div class="vital-row"><span>Mana Intake (Meals)</span> <input type="number" id="meal-in" class="vital-input" onchange="saveVitals()"></div>
            </div>
            <div style="text-align: center; margin-top: 30px; font-style: italic; font-size: 0.9rem; color: var(--gold); opacity: 0.7;">
                "Even the oldest trees must drink."
            </div>
        </div>
    </div>

    <script>
        let currentRoom = 'hearth';
        let timerInstance;
        const audH = document.getElementById('audio-hearth');
        const audG = document.getElementById('audio-garden');
        const vidS = document.getElementById('scholar-video-bg');
        const pLayer = document.getElementById('particle-layer');

        function init() {
            renderCalendar();
            loadVitals();
            loadReagents();
            loadJournal();
            spawnHearthEmbers();
            audH.volume = 0.4; audG.volume = 0.4;
            audH.play().catch(()=>{}); // Handle browser autoplay rules
        }

        function toggleSidebar() {
            document.getElementById('main-sidebar').classList.toggle('open');
        }

        function switchRoom(room) {
            if(room === currentRoom) return;
            currentRoom = room;

            // Update Portal Buttons
            document.querySelectorAll('.portal-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+room).classList.add('active');
            
            // Crossfade Layers
            document.querySelectorAll('.layer-container').forEach(l => l.classList.add('invisible'));
            document.getElementById(room+'-layer').classList.remove('invisible');

            // Swap Sidebar Content
            document.querySelectorAll('.side-content').forEach(s => s.classList.add('hidden'));
            document.getElementById('side-'+room).classList.remove('hidden');

            // Audio & Particle Logic
            audH.pause(); audG.pause(); vidS.pause(); pLayer.innerHTML = '';
            
            if(room === 'hearth') { 
                audH.play(); 
                spawnHearthEmbers(); 
            }
            if(room === 'garden') { 
                audG.play(); 
                spawnGardenFlora(); 
            }
            if(room === 'scholar') { 
                vidS.muted = false; vidS.play(); 
                spawnTowerDust(); 
            }
        }

        // --- MAGICAL PARTICLE ENGINE ---
        function spawnHearthEmbers() {
            for(let i=0; i<30; i++) {
                let p = document.createElement('div'); p.className = 'ember';
                p.style.left = Math.random() * 100 + '%';
                let s = Math.random() * 3 + 2 + 'px'; p.style.width = s; p.style.height = s;
                p.style.animationDuration = (Math.random() * 5 + 4) + 's';
                p.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
                pLayer.appendChild(p);
            }
        }

        function spawnTowerDust() {
            for(let i=0; i<40; i++) {
                let p = document.createElement('div'); p.className = 'dust';
                p.style.left = Math.random() * 100 + '%';
                let s = Math.random() * 3 + 1 + 'px'; p.style.width = s; p.style.height = s;
                p.style.animationDuration = (Math.random() * 10 + 6) + 's';
                p.style.setProperty('--drift', (Math.random() * 60 - 30) + 'px');
                pLayer.appendChild(p);
            }
        }

        function spawnGardenFlora() {
            // Fast Rain Drips
            for(let i=0; i<25; i++) {
                let p = document.createElement('div'); p.className = 'drip';
                p.style.left = Math.random() * 100 + '%';
                p.style.height = (Math.random() * 20 + 10) + 'px';
                p.style.animationDuration = (Math.random() * 1.5 + 0.5) + 's';
                p.style.animationDelay = (Math.random() * 2) + 's';
                pLayer.appendChild(p);
            }
            // Drifting Petals
            for(let i=0; i<15; i++) {
                let p = document.createElement('div'); p.className = 'petal';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (Math.random() * 8 + 6) + 's';
                p.style.animationDelay = (Math.random() * 5) + 's';
                p.style.setProperty('--drift', (Math.random() * 200 - 100) + 'px');
                p.style.setProperty('--spin', (Math.random() * 360) + 'deg');
                pLayer.appendChild(p);
            }
        }

        // --- ZEN FOCUS TIMER ---
        function startFocusTimer(minutes) {
            let seconds = minutes * 60;
            clearInterval(timerInstance);
            document.getElementById('main-sidebar').classList.remove('open'); // Zen Trigger

            timerInstance = setInterval(() => {
                seconds--;
                let m = Math.floor(seconds/60); let s = seconds%60;
                document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                if(seconds <= 0) {
                    clearInterval(timerInstance);
                    document.getElementById('timer-display').innerText = "RESTORED";
                    document.getElementById('main-sidebar').classList.add('open');
                }
            }, 1000);
        }

        function resetTimer() {
            clearInterval(timerInstance);
            document.getElementById('timer-display').innerText = "25:00";
        }

        // --- DATA PERSISTENCE ---
        function updateMood(mood, el) {
            document.querySelectorAll('.mood-icons span').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected'); localStorage.setItem('hub-mood', mood);
        }

        function saveVitals() {
            localStorage.setItem('hub-sleep', document.getElementById('sleep-in').value);
            localStorage.setItem('hub-water', document.getElementById('water-in').value);
            localStorage.setItem('hub-meals', document.getElementById('meal-in').value);
        }

        function loadVitals() {
            document.getElementById('sleep-in').value = localStorage.getItem('hub-sleep') || 8;
            document.getElementById('water-in').value = localStorage.getItem('hub-water') || 0;
            document.getElementById('meal-in').value = localStorage.getItem('hub-meals') || 0;
            const m = localStorage.getItem('hub-mood');
            if(m) {
                const map = {ethereal:0, grounded:1, flickering:2, stormy:3, waning:4};
                document.querySelectorAll('.mood-icons span')[map[m]].classList.add('selected');
            }
        }

        function addReagent() {
            const val = document.getElementById('reagent-input').value;
            if(!val) return;
            const r = JSON.parse(localStorage.getItem('hub-reagents') || '[]');
            r.push(val); localStorage.setItem('hub-reagents', JSON.stringify(r));
            document.getElementById('reagent-input').value = ''; renderReagents();
        }

        function renderReagents() {
            const r = JSON.parse(localStorage.getItem('hub-reagents') || '[]');
            document.getElementById('reagent-display').innerHTML = r.map((item, i) => 
                `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>‚ú¶ ${item}</span><span style="color:#8a3324; cursor:pointer" onclick="removeReagent(${i})">√ó</span></div>`
            ).join('');
        }

        function removeReagent(i) {
            const r = JSON.parse(localStorage.getItem('hub-reagents') || '[]');
            r.splice(i, 1); localStorage.setItem('hub-reagents', JSON.stringify(r)); renderReagents();
        }

        function logJournal() {
            const note = document.getElementById('work-note').value;
            if(!note) return;
            const j = JSON.parse(localStorage.getItem('hub-journal') || '[]');
            j.unshift({time: new Date().toLocaleString(), text: note});
            localStorage.setItem('hub-journal', JSON.stringify(j));
            document.getElementById('work-note').value = ''; loadJournal();
        }

        function loadJournal() {
            const j = JSON.parse(localStorage.getItem('hub-journal') || '[]');
            document.getElementById('journal-preview').innerHTML = j.slice(0, 5).map(entry => 
                `<div style="border-bottom:1px solid rgba(212,175,55,0.1); padding:8px 0; margin-bottom:5px;"><small style="color:var(--gold); font-size:0.7rem;">${entry.time}</small><br>${entry.text}</div>`
            ).join('');
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-body');
            const now = new Date();
            for(let i=1; i<=31; i++) {
                let d = document.createElement('div'); d.className = 'day-num'; d.innerText = i;
                if(i === now.getDate()) d.classList.add('today');
                container.appendChild(d);
            }
        }

        function exportData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'sovereign_hub_data.json'; a.click();
        }
    </script>
</body>
</html>
