<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moon's Hearth - Master Provisioner's Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
    :root {
        --gold: #d4af37;
        --gold-glow: rgba(212, 175, 55, 0.4);
        --fire: #ff6a00;
        --fire-glow: rgba(255, 106, 0, 0.7);
        --glass: rgba(10, 8, 6, 0.88);
        --text: #fdf5e6;
        --parchment: #e3d5b8;
        --ink: #2c1810;
    }

    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        font-family: 'Cormorant Garamond', serif;
        background-color: #000; color: var(--text);
        overflow: hidden; cursor: crosshair;
    }

    /* --- Entrance Overlay (Audio Key) --- */
    #enter-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #1a120e 0%, #000 100%);
        z-index: 2000; display: flex; flex-direction: column;
        justify-content: center; align-items: center; transition: opacity 1.2s ease;
    }
    .enter-btn {
        font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);
        background: rgba(0,0,0,0.5); border: 1px solid var(--gold); padding: 15px 45px;
        cursor: pointer; letter-spacing: 5px; transition: 0.4s;
        box-shadow: 0 0 30px var(--gold-glow); text-transform: uppercase;
    }
    .enter-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 50px var(--gold); }

    /* --- Atmospheric Layers --- */
    .bg-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: url('image_5.png') no-repeat center center;
        background-size: cover; z-index: 0;
        animation: flicker 12s infinite alternate ease-in-out;
    }
    @keyframes flicker { 0% { filter: brightness(0.7) contrast(1.1); } 100% { filter: brightness(1) contrast(1.2); } }
    
    .vignette {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.95) 100%);
        z-index: 1; pointer-events: none;
    }

    /* --- THE FLOATING EMBERS --- */
    #particles { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 5; pointer-events: none; overflow: hidden;
    }
    .ember {
        position: absolute; bottom: -20px; background: var(--fire); border-radius: 50%;
        box-shadow: 0 0 12px var(--fire), 0 0 24px var(--fire-glow);
        opacity: 0; animation: rise linear infinite;
    }
    @keyframes rise {
        0% { opacity: 0; transform: translateY(0) scale(1); }
        20% { opacity: 0.9; }
        100% { opacity: 0; transform: translateY(-110vh) scale(0.3) translateX(var(--drift)); }
    }

    /* --- Navigation --- */
    .room-portal {
        position: absolute; left: 40px; top: 40px; z-index: 100;
        display: flex; gap: 15px;
    }
    .portal-btn {
        background: var(--glass); border: 1px solid var(--gold-glow); color: var(--gold);
        padding: 10px 20px; font-family: 'Cinzel'; font-size: 0.8rem; cursor: pointer; transition: 0.3s;
    }
    .portal-btn.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

    /* --- UI Container (Right Side) --- */
    .ui-container {
        position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
        z-index: 10; display: flex; flex-direction: column; gap: 15px; width: 450px;
    }
    .glass-panel {
        background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border: 1px solid var(--gold-glow); padding: 22px;
        box-shadow: 0 25px 70px #000;
    }
    .panel-header { text-align: center; border-bottom: 1px solid var(--gold); padding-bottom: 8px; margin-bottom: 12px; }
    .panel-header h1 { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--gold); margin: 0; letter-spacing: 2px; }

    /* --- Almanac & Active Endeavors --- */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-family: 'Cinzel'; font-size: 0.7rem; }
    .day-num { padding: 6px; border: 1px solid rgba(212, 175, 55, 0.1); cursor: pointer; transition: 0.3s; }
    .day-num.today { background: var(--gold); color: #000; font-weight: bold; }
    .day-num.has-log { border-color: var(--gold); color: var(--gold); }

    .manifest-body { font-size: 1.1rem; line-height: 1.4; color: var(--parchment); font-style: italic; max-height: 100px; overflow-y: auto; text-align: left; }
    .empty-msg { opacity: 0.4; font-size: 0.9rem; text-align: center; }

    /* --- Reagent List --- */
    .reagent-input-box { display: flex; gap: 8px; margin-bottom: 10px; }
    input[type="text"] { flex-grow: 1; background: rgba(0,0,0,0.4); border: 1px solid var(--gold-glow); color: var(--text); padding: 8px; outline: none; font-family: 'Cormorant Garamond'; }
    .reagent-list { max-height: 120px; overflow-y: auto; text-align: left; }
    .reagent-item { display: flex; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(212, 175, 55, 0.1); }
    .reagent-name.checked { text-decoration: line-through; opacity: 0.5; }

    /* --- Scholar's Wing Progress --- */
    .apprentice-section { margin-bottom: 15px; }
    .apprentice-name { font-family: 'Cinzel'; font-size: 0.9rem; color: var(--gold); display: flex; justify-content: space-between; margin-bottom: 5px; }
    .progress-track { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold-glow); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #fff); width: 0%; transition: width 0.8s ease; }

    .subject-list { display: flex; flex-direction: column; gap: 8px; }
    .subject-item { display: flex; align-items: center; gap: 10px; font-size: 1rem; cursor: pointer; opacity: 0.8; transition: 0.3s; }
    .subject-item:hover { opacity: 1; color: var(--gold); }
    .check-box { width: 14px; height: 14px; border: 1px solid var(--gold); position: relative; }
    .check-box.done::after { content: '✦'; position: absolute; top: -5px; left: 0; color: var(--gold); font-size: 12px; }

    /* --- Utilities --- */
    .hidden { display: none !important; }
    .data-btn { background: transparent; border: 1px solid var(--gold-glow); color: var(--gold); font-family: 'Cinzel'; font-size: 0.6rem; padding: 5px 12px; cursor: pointer; transition: 0.3s; }
    .data-btn:hover { background: var(--gold); color: #000; }

    /* --- Modal --- */
    #log-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 3000; display: none;
        justify-content: center; align-items: center; opacity: 0; transition: 0.5s;
    }
    .scroll-parchment {
        background: var(--parchment); color: var(--ink); width: 85%; max-width: 480px;
        padding: 40px; border: 2px solid #8b5a2b; border-radius: 5px 40px 5px 40px; position: relative;
    }
    textarea { width: 100%; height: 120px; background: transparent; border: none; border-bottom: 1px solid #8b5a2b; font-size: 1.2rem; margin-top: 15px; outline: none; resize: none; font-family: 'Cormorant Garamond'; }

</style>
</head>
<body>

    <div id="enter-overlay">
        <h2 style="font-family:'Cinzel'; color:var(--gold); letter-spacing:10px; margin-bottom:30px;">MOON'S HEARTH</h2>
        <button class="enter-btn" onclick="igniteHearth()">Enter the Hearth</button>
    </div>

    <div class="bg-layer"></div>
    <div class="vignette"></div>
    <div id="particles"></div>
    <audio id="hearth-audio" loop><source src="fire.mp3" type="audio/mpeg"></audio>

    <div class="room-portal">
        <button id="btn-hearth" class="portal-btn active" onclick="switchRoom('hearth')">The Hearth</button>
        <button id="btn-scholar" class="portal-btn" onclick="switchRoom('scholar')">Scholar's Wing</button>
    </div>

    <div class="ui-container">
        
        <div id="panel-hearth">
            <div class="glass-panel" style="margin-bottom:15px;">
                <div class="panel-header"><h1>Active Endeavors</h1></div>
                <div id="manifest-content" class="manifest-body">
                    <p class="empty-msg">No active endeavors recorded for today.</p>
                </div>
            </div>

            <div class="glass-panel">
                <div class="panel-header">
                    <h1 id="current-month">The Almanac</h1>
                    <p id="current-year" style="font-family:'Cinzel'; font-size:0.6rem; color:var(--gold); margin-top:5px;"></p>
                </div>
                <div class="calendar-grid" id="calendar-body"></div>
            </div>

            <div class="glass-panel" style="margin-top:15px;">
                <div class="panel-header"><h1>Master's Reagent List</h1></div>
                <div class="reagent-input-box">
                    <input type="text" id="reagent-input" placeholder="Acquire reagents...">
                    <button class="data-btn" onclick="addReagent()" style="font-size:0.8rem">Acquire</button>
                </div>
                <div class="reagent-list" id="reagent-display"></div>
            </div>
        </div>

        <div id="panel-scholar" class="hidden">
            <div class="glass-panel">
                <div class="panel-header">
                    <h1>The Scholar's Wing</h1>
                    <p style="font-family:'Cinzel'; font-size:0.6rem; color:var(--gold); margin-top:5px;">Explorer's Supplemental Study</p>
                </div>

                <div class="apprentice-section">
                    <div class="apprentice-name"><span>Supplemental Progress</span><span id="study-percent">0%</span></div>
                    <div class="progress-track"><div id="study-bar" class="progress-fill"></div></div>
                    <div class="subject-list">
                        <div class="subject-item" onclick="toggleSubject(0)"><div class="check-box s-check"></div> <b>Comparative Lore:</b> Non-secular global myths.</div>
                        <div class="subject-item" onclick="toggleSubject(1)"><div class="check-box s-check"></div> <b>The Bardic Path:</b> Music & sound design.</div>
                        <div class="subject-item" onclick="toggleSubject(2)"><div class="check-box s-check"></div> <b>The Artisan's Eye:</b> Visual digital design.</div>
                        <div class="subject-item" onclick="toggleSubject(3)"><div class="check-box s-check"></div> <b>Hearth Resilience:</b> Survival & prep.</div>
                        <div class="subject-item" onclick="toggleSubject(4)"><div class="check-box s-check"></div> <b>The Merchant's Code:</b> Real-world logic.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="display:flex; justify-content:space-around; padding:12px;">
            <button class="data-btn" onclick="exportData()">Export Scroll</button>
            <button class="data-btn" onclick="document.getElementById('import-file').click()">Import Scroll</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(event)">
        </div>
    </div>

    <div id="log-modal" onclick="closeLog()">
        <div class="scroll-parchment" onclick="event.stopPropagation()">
            <span style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:1.5rem;" onclick="closeLog()">×</span>
            <h2 id="log-date-title" style="font-family:'Cinzel'; text-align:center;"></h2>
            <textarea id="log-entry" placeholder="Record provisions, study sessions, or travel routes..."></textarea>
            <button class="data-btn" onclick="saveLog()" style="width:100%; margin-top:15px; padding:10px; font-size:1rem;">Finalize Record</button>
        </div>
    </div>

    <script>
        const audio = document.getElementById('hearth-audio');
        let selectedDate = '';
        let schoolData = [false, false, false, false, false];

        function igniteHearth() {
            document.getElementById('enter-overlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('enter-overlay').style.display = 'none'; }, 1000);
            audio.volume = 0.5; audio.play();
            
            // Initializing Systems
            const savedLore = localStorage.getItem('worldLoreProgress');
            if(savedLore) schoolData = JSON.parse(savedLore);

            renderCalendar(); 
            renderReagents(); 
            updateTodayManifest(); 
            updateSchoolUI();
            createEmbers(); 
        }

        /* --- EMBER ENGINE --- */
        function createEmbers() {
            const pCont = document.getElementById('particles');
            pCont.innerHTML = ''; 
            for(let i=0; i<65; i++) {
                let e = document.createElement('div');
                e.className = 'ember';
                e.style.left = Math.random() * 100 + '%';
                let s = (Math.random() * 4 + 2) + 'px';
                e.style.width = s; e.style.height = s;
                e.style.animationDuration = (Math.random() * 6 + 4) + 's';
                e.style.animationDelay = (Math.random() * 5) + 's';
                e.style.setProperty('--drift', (Math.random() - 0.5) * 180 + 'px');
                pCont.appendChild(e);
            }
        }

        /* --- ROOM SWITCHER --- */
        function switchRoom(room) {
            document.getElementById('panel-hearth').classList.toggle('hidden', room !== 'hearth');
            document.getElementById('panel-scholar').classList.toggle('hidden', room !== 'scholar');
            document.getElementById('btn-hearth').classList.toggle('active', room === 'hearth');
            document.getElementById('btn-scholar').classList.toggle('active', room === 'scholar');
        }

        /* --- MANIFEST & ALMANAC --- */
        function updateTodayManifest() {
            const now = new Date();
            const key = `log-${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;
            const content = localStorage.getItem(key);
            const display = document.getElementById('manifest-content');
            if(content) {
                display.innerHTML = `<p>✦ ${content.replace(/\n/g, '<br>✦ ')}</p>`;
            } else {
                display.innerHTML = `<p class="empty-msg">No active endeavors recorded for today.</p>`;
            }
        }

        function renderCalendar() {
            const now = new Date();
            const monthNames = ["Morning Star", "Sun's Dawn", "First Seed", "Rain's Hand", "Second Seed", "Midyear", "Sun's Height", "Last Seed", "Hearthfire", "Frostfall", "Sun's Dusk", "Evening Star"];
            document.getElementById('current-month').innerText = monthNames[now.getMonth()];
            document.getElementById('current-year').innerText = "Year " + now.getFullYear();
            const calBody = document.getElementById('calendar-body');
            calBody.innerHTML = '';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                let dEl = document.createElement('div'); dEl.style.color = 'var(--gold)'; dEl.innerText = d; calBody.appendChild(dEl);
            });
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) calBody.appendChild(document.createElement('div'));
            for(let d=1; d<=totalDays; d++) {
                let dNum = document.createElement('div'); dNum.className = 'day-num';
                let key = `log-${now.getFullYear()}-${now.getMonth()}-${d}`;
                if(localStorage.getItem(key)) dNum.classList.add('has-log');
                if(d === now.getDate()) dNum.classList.add('today');
                dNum.innerText = d; dNum.onclick = () => openLog(d, key);
                calBody.appendChild(dNum);
            }
        }

        function openLog(day, key) {
            selectedDate = key;
            document.getElementById('log-date-title').innerText = `Record for Day ${day}`;
            document.getElementById('log-entry').value = localStorage.getItem(key) || '';
            const m = document.getElementById('log-modal');
            m.style.display = 'flex'; setTimeout(() => { m.style.opacity = '1'; }, 10);
        }

        function saveLog() {
            const val = document.getElementById('log-entry').value;
            if(!val.trim()) localStorage.removeItem(selectedDate);
            else localStorage.setItem(selectedDate, val);
            closeLog(); renderCalendar(); updateTodayManifest();
        }

        function closeLog() {
            const m = document.getElementById('log-modal');
            m.style.opacity = '0'; setTimeout(() => { m.style.display = 'none'; }, 500);
        }

        /* --- SCHOLAR LOGIC --- */
        function toggleSubject(idx) {
            schoolData[idx] = !schoolData[idx];
            localStorage.setItem('worldLoreProgress', JSON.stringify(schoolData));
            updateSchoolUI();
        }

        function updateSchoolUI() {
            const checks = document.querySelectorAll('.s-check');
            let count = 0;
            schoolData.forEach((done, i) => {
                if(done) { checks[i].classList.add('done'); count++; }
                else { checks[i].classList.remove('done'); }
            });
            const percent = (count / 5) * 100;
            document.getElementById('study-bar').style.width = percent + '%';
            document.getElementById('study-percent').innerText = Math.round(percent) + '%';
        }

        /* --- REAGENT LOGIC --- */
        function addReagent() {
            const input = document.getElementById('reagent-input');
            const val = input.value.trim();
            if(!val) return;
            const items = JSON.parse(localStorage.getItem('reagents') || '[]');
            items.push({ name: val, checked: false });
            localStorage.setItem('reagents', JSON.stringify(items));
            input.value = ''; renderReagents();
        }

        function renderReagents() {
            const display = document.getElementById('reagent-display');
            const items = JSON.parse(localStorage.getItem('reagents') || '[]');
            display.innerHTML = '';
            items.forEach((it, idx) => {
                display.innerHTML += `<div class="reagent-item">
                    <span class="reagent-name ${it.checked ? 'checked' : ''}" onclick="toggleReagent(${idx})">✦ ${it.name}</span>
                    <span style="color:#8a3324; cursor:pointer; font-weight:bold" onclick="removeReagent(${idx})">X</span>
                </div>`;
            });
        }

        function toggleReagent(idx) {
            const items = JSON.parse(localStorage.getItem('reagents') || '[]');
            items[idx].checked = !items[idx].checked;
            localStorage.setItem('reagents', JSON.stringify(items));
            renderReagents();
        }

        function removeReagent(idx) {
            const items = JSON.parse(localStorage.getItem('reagents') || '[]');
            items.splice(idx, 1);
            localStorage.setItem('reagents', JSON.stringify(items));
            renderReagents();
        }

        /* --- CHRONOMANCY (DATA TOOLS) --- */
        function exportData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'moons-hearth-scroll.json'; a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                for(const k in data) localStorage.setItem(k, data[k]);
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
