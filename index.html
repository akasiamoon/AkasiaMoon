<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moon's Hearth - The Sovereign Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
    :root { --gold: #d4af37; --gold-glow: rgba(212, 175, 55, 0.4); --fire: #ff6a00; --glass: rgba(15, 12, 10, 0.9); --text: #fdf5e6; --parchment: #e3d5b8; --ink: #2c1810; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Cormorant Garamond', serif; background-color: #000; color: var(--text); overflow: hidden; }

    /* --- GLOBAL LAYERS --- */
    .layer-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 1s ease; background-size: cover; background-position: center; z-index: 1; }
    .hidden { display: none !important; }
    .invisible { opacity: 0; pointer-events: none; }
    #hearth-layer { background-image: url('image_5.png'); }
    #garden-layer { background-image: url('garden_bg.png'); background-color: #111; }
    #scholar-video-bg { width: 100%; height: 100%; object-fit: cover; position: absolute; }

    /* --- OVERLAYS & PORTALS --- */
    #enter-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a120e 0%, #000 100%); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1.2s ease; }
    .enter-btn { font-family: 'Cinzel', serif; color: var(--gold); background: rgba(0,0,0,0.6); border: 1px solid var(--gold); cursor: pointer; transition: 0.3s; font-size: 1.5rem; padding: 15px 45px; letter-spacing: 5px; text-transform: uppercase; box-shadow: 0 0 30px var(--gold-glow); }
    .enter-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold-glow); }

    .room-portal { position: fixed; left: 30px; top: 30px; z-index: 2000; display: flex; gap: 10px; }
    .portal-btn, .data-btn { font-family: 'Cinzel', serif; color: var(--gold); background: rgba(0,0,0,0.6); border: 1px solid var(--gold); cursor: pointer; transition: 0.3s; padding: 8px 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; outline: none; }
    .portal-btn:hover, .portal-btn.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold-glow); }

    .sidebar-toggle { position: fixed; right: 25px; top: 30px; z-index: 2000; width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); color: var(--gold); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.4s; }
    .sidebar-toggle:hover { transform: rotate(15deg) scale(1.1); background: var(--gold); color: #000; }

    /* --- WEATHER WIDGET (RESTORED) --- */
    .weather-widget { position: absolute; top: 20px; right: 260px; z-index: 2500; background: radial-gradient(circle, rgba(40, 30, 20, 0.9) 0%, rgba(10, 8, 5, 0.95) 100%); border: 2px solid var(--gold); width: 110px; height: 110px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 15px var(--gold-glow); transition: 0.8s; opacity: 0; pointer-events: none; }
    .weather-widget.visible { opacity: 1; pointer-events: auto; }
    #weather-icon { font-size: 2rem; z-index: 2; margin-bottom: 2px; filter: drop-shadow(0 0 8px var(--gold)); }
    #weather-temp { font-family: 'Cinzel'; color: var(--gold); font-size: 1.2rem; font-weight: 900; z-index: 2; }
    #weather-desc { font-family: 'Cormorant Garamond'; color: var(--parchment); font-size: 0.6rem; font-style: italic; letter-spacing: 1px; text-transform: uppercase; }

    /* --- SIDEBAR & UI ELEMENTS --- */
    .sidebar { position: fixed; right: -450px; top: 0; width: 420px; height: 100%; background: var(--glass); backdrop-filter: blur(25px); border-left: 1px solid var(--gold-glow); z-index: 1000; transition: right 0.7s cubic-bezier(0.19, 1, 0.22, 1); padding: 90px 35px 40px 35px; box-sizing: border-box; overflow-y: auto; }
    .sidebar.open { right: 0; }
    .panel-header h1 { font-family: 'Cinzel'; font-size: 1.1rem; color: var(--gold); text-align: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 25px; letter-spacing: 4px; text-transform: uppercase; }
    .section-box { margin-bottom: 25px; border: 1px solid rgba(212,175,55,0.2); padding: 20px; background: rgba(255,255,255,0.02); }
    .vital-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-family: 'Cinzel'; font-size: 0.8rem; letter-spacing: 1px; }
    .vital-input { background: rgba(0,0,0,0.3); border: 1px solid var(--gold-glow); color: var(--gold); font-family: 'Cinzel'; width: 60px; text-align: center; padding: 5px; outline: none; }
    .scholar-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--gold-glow); color: var(--parchment); padding: 12px; font-family: 'Cormorant Garamond'; margin-bottom: 10px; outline: none; box-sizing: border-box; }
    .mood-icons { display: flex; gap: 15px; font-size: 1.5rem; justify-content: center; margin: 10px 0; }
    .mood-icons span { cursor: pointer; opacity: 0.3; transition: 0.4s; }
    .mood-icons span.selected { opacity: 1; filter: drop-shadow(0 0 8px var(--gold)); transform: scale(1.2); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.7rem; font-family: 'Cinzel'; }
    .day-num { padding: 8px 0; border: 1px solid rgba(212,175,55,0.1); cursor: pointer; transition: 0.3s; }
    .day-num.today { background: var(--gold); color: #000; font-weight: 900; }
    .day-num.has-log { border-color: var(--gold); color: var(--gold); }

    /* --- TOWER CLICK ZONES (RESTORED) --- */
    .scholar-click-layer { z-index: 25; }
    .click-zone { position: absolute; cursor: pointer; transition: 0.3s; z-index: 25; border-radius: 5px; }
    .click-zone:hover { box-shadow: inset 0 0 30px var(--gold-glow), 0 0 15px var(--gold-glow); background: rgba(212,175,55,0.1); }
    #zone-lore { top: 58%; left: 5%; width: 18%; height: 25%; } 
    #zone-bard { top: 63%; right: 5%; width: 15%; height: 20%; } 
    #zone-art { top: 20%; left: 2%; width: 12%; height: 15%; } 
    #zone-survival { top: 55%; left: 53%; width: 10%; height: 20%; } 
    #zone-merchant { top: 75%; left: 68%; width: 25%; height: 15%; } 

    /* --- GRIMOIRE & LOG MODALS (RESTORED) --- */
    #grimoire-modal, #log-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.5s; }
    .scroll-parchment { background: var(--parchment); color: var(--ink); width: 90%; max-width: 700px; padding: 40px; border-radius: 5px 40px; position: relative; box-shadow: 0 0 50px #000; border: 2px solid #8b5a2b; height: 85vh; display: flex; flex-direction: column; }
    .grimoire-tabs { display: flex; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid #8b5a2b; }
    .tab-btn { background: none; border: none; font-family: 'Cinzel'; cursor: pointer; padding: 5px 10px; color: #8b5a2b; opacity: 0.5; transition: 0.3s; }
    .tab-btn.active { opacity: 1; border-bottom: 2px solid #8b5a2b; }
    #grimoire-toc { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; font-family: 'Cinzel'; max-height: 40px; overflow-y: auto; }
    .toc-link { color: #8b5a2b; cursor: pointer; text-decoration: underline; opacity: 0.7; }
    .grimoire-textarea { width: 100%; flex-grow: 1; background: rgba(0,0,0,0.03); border: 1px solid rgba(139, 90, 43, 0.3); padding: 15px; font-family: 'Cormorant Garamond'; font-size: 1.2rem; line-height: 1.5; outline: none; resize: none; color: var(--ink); }
    #lexicon-view, #legend-view { display: none; flex-direction: column; flex-grow: 1; overflow: hidden; }
    .lexicon-list, .legend-list { flex-grow: 1; overflow-y: auto; border: 1px solid rgba(139, 90, 43, 0.2); padding: 15px; background: rgba(0,0,0,0.02); }
    .lexicon-item, .legend-item { display: flex; align-items: flex-start; justify-content: space-between; border-bottom: 1px solid rgba(139, 90, 43, 0.1); padding: 10px 0; }
    .progress-track { width: 100%; height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; margin: 10px 0 20px 0; border: 1px solid #8b5a2b; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s ease; }

    /* --- ANIMATION ENGINE (PARTICLES) --- */
    #particle-layer { pointer-events: none; position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; overflow: hidden; }
    .ember { position: absolute; border-radius: 50%; background: var(--fire); box-shadow: 0 0 10px var(--fire); opacity: 0; animation: rise linear infinite; }
    .dust { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3); box-shadow: 0 0 8px rgba(255,255,255,0.2); opacity: 0; animation: drift linear infinite; }
    .drip { position: absolute; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.5)); width: 2px; border-radius: 2px; opacity: 0; animation: fallDrip linear infinite; }
    .petal { position: absolute; background: #c84b31; width: 8px; height: 8px; border-radius: 50% 0 50% 50%; opacity: 0; animation: fallPetal linear infinite; box-shadow: 0 0 5px rgba(200,75,49,0.5); }
    
    @keyframes rise { 0% {opacity:0; transform:translateY(110vh) translateX(0);} 20% {opacity:0.8;} 100% {opacity:0; transform:translateY(-10vh) translateX(var(--drift));} }
    @keyframes drift { 0% {opacity:0; transform:translateY(100vh) translateX(0);} 50% {opacity:0.5;} 100% {opacity:0; transform:translateY(-10vh) translateX(var(--drift));} }
    @keyframes fallDrip { 0% { opacity: 0; transform: translateY(-10vh); } 10% { opacity: 0.5; } 100% { opacity: 0; transform: translateY(110vh); } }
    @keyframes fallPetal { 0% { opacity: 0; transform: translateY(-10vh) translateX(0) rotate(0deg); } 20% { opacity: 0.8; } 100% { opacity: 0; transform: translateY(110vh) translateX(var(--drift)) rotate(var(--spin)); } }
</style>
</head>
<body>

    <div id="enter-overlay">
        <h2 style="font-family:'Cinzel'; color:var(--gold); letter-spacing:10px; margin-bottom:30px;">MOON'S HEARTH</h2>
        <button class="enter-btn" onclick="igniteRealm()">Enter the Realm</button>
    </div>

    <div class="room-portal">
        <button id="btn-hearth" class="portal-btn active" onclick="switchRoom('hearth')">Hearth</button>
        <button id="btn-scholar" class="portal-btn" onclick="switchRoom('scholar')">Tower</button>
        <button id="btn-garden" class="portal-btn" onclick="switchRoom('garden')">Garden</button>
    </div>

    <button id="ui-toggle" class="sidebar-toggle" onclick="toggleSidebar()">üìú</button>

    <div id="weather-widget" class="weather-widget">
        <div id="weather-icon">‚ú®</div>
        <div id="weather-temp">--¬∞F</div>
        <div id="weather-desc">Scrying...</div>
    </div>

    <audio id="audio-hearth" loop src="fire.mp3"></audio>
    <audio id="audio-garden" loop src="nature.mp3"></audio>

    <div id="hearth-layer" class="layer-container"></div>
    
    <div id="scholar-layer" class="layer-container invisible">
        <video id="scholar-video-bg" loop muted playsinline><source src="scholar_bg.mp4" type="video/mp4"></video>
        <div class="scholar-click-layer layer-container">
            <div id="zone-lore" class="click-zone" onclick="openGrimoire('Global Mythos')" title="Global Mythos"></div>
            <div id="zone-bard" class="click-zone" onclick="openGrimoire('Bardic Arts')" title="Bardic Arts"></div>
            <div id="zone-art" class="click-zone" onclick="openGrimoire('Visual Design')" title="Visual Design"></div>
            <div id="zone-survival" class="click-zone" onclick="openGrimoire('Hearth Resilience')" title="Hearth Resilience"></div>
            <div id="zone-merchant" class="click-zone" onclick="openGrimoire('Guild Logic')" title="Guild Logic"></div>
        </div>
    </div>

    <div id="garden-layer" class="layer-container invisible"></div>

    <div id="particle-layer"></div>

    <div id="main-sidebar" class="sidebar">
        <div id="side-hearth" class="side-content">
            <div class="panel-header"><h1>Hearth Almanac</h1></div>
            <div class="section-box"><div class="calendar-grid" id="calendar-body"></div></div>
            <div class="section-box">
                <h3 style="font-family:'Cinzel'; font-size:0.8rem; color:var(--gold); margin-bottom:15px;">Apothecary Reagents</h3>
                <input type="text" id="reagent-input" class="scholar-input" placeholder="Scribe herb or mineral..." onkeydown="if(event.key==='Enter') addReagent()">
                <div id="reagent-display" style="max-height:150px; overflow-y:auto; font-size:1.1rem; border-top: 1px solid rgba(212,175,55,0.1); padding-top:10px;"></div>
            </div>
            <button class="data-btn" style="width:100%" onclick="exportData()">Export Data Scroll</button>
        </div>

        <div id="side-scholar" class="side-content hidden">
            <div class="panel-header"><h1>Scholar's Focus</h1></div>
            <div class="section-box" style="text-align:center;">
                <div id="timer-display" style="font-family:'Cinzel'; font-size:2.8rem; color:var(--gold); margin-bottom:15px; text-shadow: 0 0 10px var(--gold-glow);">25:00</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="data-btn" onclick="startFocusTimer(25)">Begin Focus</button>
                    <button class="data-btn" style="border-color:#8a3324; color:#8a3324;" onclick="resetTimer()">Reset</button>
                </div>
            </div>
            <div class="section-box">
                <h3 style="font-family:'Cinzel'; font-size:0.8rem; color:var(--gold);">Grimoire Entry</h3>
                <textarea id="work-note" class="scholar-input" style="height:100px;" placeholder="What lore are you unearthing?"></textarea>
                <button class="data-btn" style="width:100%;" onclick="logJournal()">Scribe to Journal</button>
            </div>
            <div id="journal-preview" style="max-height:150px; overflow-y:auto; font-size:0.9rem; opacity:0.8;"></div>
        </div>

        <div id="side-garden" class="side-content hidden">
            <div class="panel-header"><h1>Vital Alchemy</h1></div>
            <div class="section-box">
                <div style="font-family:'Cinzel'; text-align:center; color:var(--gold); font-size:0.8rem; margin-bottom:10px;">Spirit Alignment</div>
                <div class="mood-icons" id="mood-picker">
                    <span onclick="updateMood('ethereal', this)" title="Ethereal">‚ú®</span>
                    <span onclick="updateMood('grounded', this)" title="Grounded">üåø</span>
                    <span onclick="updateMood('flickering', this)" title="Flickering">üî•</span>
                    <span onclick="updateMood('stormy', this)" title="Stormy">‚õàÔ∏è</span>
                    <span onclick="updateMood('waning', this)" title="Waning">üåë</span>
                </div>
            </div>
            <div class="section-box">
                <div class="vital-row"><span>Dream Cycles (Sleep)</span> <input type="number" id="sleep-in" class="vital-input" onchange="saveVitals()"></div>
                <div class="vital-row"><span>Restorative Elixir (Water)</span> <input type="number" id="water-in" class="vital-input" onchange="saveVitals()"></div>
                <div class="vital-row"><span>Mana Intake (Meals)</span> <input type="number" id="meal-in" class="vital-input" onchange="saveVitals()"></div>
            </div>
        </div>
    </div>

    <div id="grimoire-modal" onclick="closeGrimoire()">
        <div class="scroll-parchment" onclick="event.stopPropagation()">
            <span style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:1.5rem;" onclick="closeGrimoire()">√ó</span>
            <div class="grimoire-tabs">
                <button id="tab-grim" class="tab-btn active" onclick="toggleView('grim')">Grimoire</button>
                <button id="tab-lex" class="tab-btn" onclick="toggleView('lex')">Lexicon</button>
                <button id="tab-leg" class="tab-btn" onclick="toggleView('leg')">Legend</button>
            </div>
            <h2 id="grimoire-title" style="font-family:'Cinzel'; text-align:center; margin-bottom:10px;"></h2>
            
            <div id="grimoire-view" style="display:flex; flex-direction:column; flex-grow:1;">
                <div id="grimoire-toc"></div>
                <textarea id="grimoire-text" class="grimoire-textarea" oninput="updateTOC()" placeholder="Scribe your research... use '#' for chapters."></textarea>
                <button class="data-btn" onclick="saveGrimoire()" style="width:100%; margin-top:15px; color:#000; background:var(--gold); padding:10px;">Scribe to Grimoire</button>
            </div>

            <div id="lexicon-view">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="lex-term" class="scholar-input" style="width:30%" placeholder="New Term...">
                    <input type="text" id="lex-def" class="scholar-input" style="width:60%" placeholder="Definition...">
                    <button class="data-btn" onclick="addLexicon()">Add</button>
                </div>
                <div class="lexicon-list" id="lexicon-list"></div>
            </div>

            <div id="legend-view">
                <div class="progress-track"><div id="legend-bar" class="progress-fill"></div></div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="leg-input" class="scholar-input" style="flex-grow:1" placeholder="New Milestone Quest...">
                    <button class="data-btn" onclick="addLegend()">Add Quest</button>
                </div>
                <div class="legend-list" id="legend-list"></div>
            </div>
        </div>
    </div>

    <div id="log-modal" onclick="closeLog()">
        <div class="scroll-parchment" onclick="event.stopPropagation()" style="height:auto;">
            <span style="position:absolute; top:15px; right:20px; cursor:pointer;" onclick="closeLog()">√ó</span>
            <h2 id="log-date-title" style="font-family:'Cinzel'; text-align:center; margin-bottom:20px;"></h2>
            <textarea id="log-entry" style="width:100%; height:200px; background:rgba(0,0,0,0.05); border:1px solid #8b5a2b; padding:15px; font-family:serif; font-size:1.1rem; outline:none;"></textarea>
            <button class="data-btn" onclick="saveLog()" style="width:100%; margin-top:20px; color:#000; background:var(--gold); padding:10px;">Finalize Record</button>
        </div>
    </div>

    <script>
        let currentRoom = 'hearth';
        let timerInstance;
        let selectedDate = '';
        let activeGrimoire = '';
        const audH = document.getElementById('audio-hearth');
        const audG = document.getElementById('audio-garden');
        const vidS = document.getElementById('scholar-video-bg');
        const pLayer = document.getElementById('particle-layer');

        function igniteRealm() {
            document.getElementById('enter-overlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('enter-overlay').style.display = 'none'; }, 1200);
            renderCalendar(); loadVitals(); loadReagents(); loadJournal(); fetchWeather();
            audH.volume = 0.4; audG.volume = 0.4;
            audH.play().catch(e=>console.log("Audio play blocked until interaction"));
            spawnHearthEmbers();
            document.getElementById('weather-widget').classList.add('visible');
        }

        function toggleSidebar() { document.getElementById('main-sidebar').classList.toggle('open'); }

        function switchRoom(room) {
            if(room === currentRoom) return;
            currentRoom = room;

            document.querySelectorAll('.portal-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+room).classList.add('active');
            
            document.querySelectorAll('.layer-container').forEach(l => l.classList.add('invisible'));
            document.getElementById(room+'-layer').classList.remove('invisible');

            document.querySelectorAll('.side-content').forEach(s => s.classList.add('hidden'));
            document.getElementById('side-'+room).classList.remove('hidden');

            audH.pause(); audG.pause(); vidS.pause(); pLayer.innerHTML = '';
            
            if(room === 'hearth') { audH.play(); spawnHearthEmbers(); }
            if(room === 'garden') { audG.play(); spawnGardenFlora(); }
            if(room === 'scholar') { vidS.muted = false; vidS.play(); spawnTowerDust(); }
        }

        // --- PARTICLE ENGINE ---
        function spawnHearthEmbers() {
            for(let i=0; i<30; i++) {
                let p = document.createElement('div'); p.className = 'ember';
                p.style.left = Math.random() * 100 + '%';
                let s = Math.random() * 3 + 2 + 'px'; p.style.width = s; p.style.height = s;
                p.style.animationDuration = (Math.random() * 5 + 4) + 's';
                p.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
                pLayer.appendChild(p);
            }
        }
        function spawnTowerDust() {
            for(let i=0; i<40; i++) {
                let p = document.createElement('div'); p.className = 'dust';
                p.style.left = Math.random() * 100 + '%';
                let s = Math.random() * 3 + 1 + 'px'; p.style.width = s; p.style.height = s;
                p.style.animationDuration = (Math.random() * 10 + 6) + 's';
                p.style.setProperty('--drift', (Math.random() * 60 - 30) + 'px');
                pLayer.appendChild(p);
            }
        }
        function spawnGardenFlora() {
            for(let i=0; i<25; i++) {
                let p = document.createElement('div'); p.className = 'drip';
                p.style.left = Math.random() * 100 + '%'; p.style.height = (Math.random() * 20 + 10) + 'px';
                p.style.animationDuration = (Math.random() * 1.5 + 0.5) + 's'; p.style.animationDelay = (Math.random() * 2) + 's';
                pLayer.appendChild(p);
            }
            for(let i=0; i<15; i++) {
                let p = document.createElement('div'); p.className = 'petal';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (Math.random() * 8 + 6) + 's'; p.style.animationDelay = (Math.random() * 5) + 's';
                p.style.setProperty('--drift', (Math.random() * 200 - 100) + 'px'); p.style.setProperty('--spin', (Math.random() * 360) + 'deg');
                pLayer.appendChild(p);
            }
        }

        // --- API WEATHER ---
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.94&longitude=-88.52&current=temperature_2m,weather_code&temperature_unit=fahrenheit');
                const data = await res.json();
                document.getElementById('weather-temp').innerText = Math.round(data.current.temperature_2m) + "¬∞F";
                document.getElementById('weather-desc').innerText = "Farmington, MS";
                let icon = "‚ú®"; const c = data.current.weather_code;
                if(c===0) icon="üåô"; else if(c<=3) icon="‚òÅÔ∏è"; else if(c>=51) icon="üåßÔ∏è";
                document.getElementById('weather-icon').innerText = icon;
            } catch(e) {}
        }

        // --- GRIMOIRE / LEXICON / LEGEND ---
        function openGrimoire(subject) {
            activeGrimoire = `grim-${subject.replace(/\s+/g, '-').toLowerCase()}`;
            document.getElementById('grimoire-title').innerText = subject;
            document.getElementById('grimoire-text').value = localStorage.getItem(activeGrimoire) || '';
            toggleView('grim'); document.getElementById('grimoire-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('grimoire-modal').style.opacity = '1', 10);
            updateTOC();
        }
        function closeGrimoire() { document.getElementById('grimoire-modal').style.opacity = '0'; setTimeout(() => document.getElementById('grimoire-modal').style.display = 'none', 500); }
        function saveGrimoire() { localStorage.setItem(activeGrimoire, document.getElementById('grimoire-text').value); closeGrimoire(); }
        
        function toggleView(v) {
            document.getElementById('grimoire-view').style.display = v==='grim'?'flex':'none';
            document.getElementById('lexicon-view').style.display = v==='lex'
